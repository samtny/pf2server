/*global alert, confirm, google, YUI */"use strict";var pf_server_url = "./pf";var unapproved = [];var unapprovedcomments = [];var recent = [];var addresschanges = [];var geocoder;$(document).ready(function () {	geocoder = new google.maps.Geocoder();	getUnapprovedLocs();	getAddressChanges();	getUnapprovedComments();	getRecentActivity();});function getAddressChanges() {		var changeurl = pf_server_url + "?t=mgmt&q=addresschanged";		$.ajax({				url: encodeURI(changeurl),				dataType: "xml",				success: handleAddressChangesResult,				error: errorGetLocs			});	}function handleAddressChangesResult(xml) {		var status = $(xml).find("status").text();	if (status === "success") {		addresschanges = locXmlToVenues(xml);	} else if (status === "nomatch") {		addresschanges = [];	} else {		alert("status: " + status);	}	refreshAddressChangesDisplay();	}function refreshAddressChangesDisplay() {		$(".addresschanges table tbody").empty();	if (addresschanges.length > 0) {		for (var i = 0; i < addresschanges.length; i++) {			$(".addresschanges table tbody").append("<tr><td><input type=\"hidden\" value=\"" + addresschanges[i].key + "\" /><input type=\"text\" value=\"" + addresschanges[i].name + "\" /></td><td><input type=\"text\" value=\"" + addresschanges[i].street + "\" /></td><td><input type=\"text\" value=\"" + addresschanges[i].city + "\" /></td><td><input type=\"text\" value=\"" + addresschanges[i].state + "\" /></td><td><input type=\"text\" value=\"" + addresschanges[i].zipcode + "\" /></td><td><input type=\"text\" value=\"" + addresschanges[i].phone + "\" /></td><td><input type=\"text\" value=\"" + addresschanges[i].url + "\" /></td><td><input type=\"hidden\" name=\"lat\" value=\"" + addresschanges[i].lat + "\" /><input type=\"hidden\" name=\"lon\" value=\"" + addresschanges[i].lon + "\" /><a href=\"http://maps.google.com?q=" + addresschanges[i].lat + "," + addresschanges[i].lon + "\" target=\"map\">" + addresschanges[i].lat + "," + addresschanges[i].lon + "</a></td><td>" + addresschanges[i].games.length + "</td><td><input type=\"button\" value=\"Update\" onclick=\"saveVenueButtonClick(this)\" /><input type=\"button\" value=\"Approve\" onclick=\"approveAddressChangeButtonClick(this, " + addresschanges[i].key + ")\" /><input type=\"button\" value=\"X\" onclick=\"deleteVenue(this, " + addresschanges[i].key + ")\" /></td></tr>");		}		$('.addresschanges h3').text("Address Changed (" + addresschanges.length + ')');		$('.addresschanges table').show();	} else {		$('.addresschanges h3').text("Address Changed (None)");		$('.addresschanges table').hide();	}	}function getRecentActivity() {		var recenturl = pf_server_url + "?l=25";		$.ajax({				url: encodeURI(recenturl),				dataType: "xml",				success: handleRecentActivityResult,				error: errorGetLocs			});	}function handleRecentActivityResult(xml) {		var status = $(xml).find("status").text();	if (status === "success") {		recent = locXmlToVenues(xml);	} else {		alert("status: " + status);	}	refreshRecentActivityDisplay();	}function refreshRecentActivityDisplay() {		$(".recent ul").empty();	if (recent.length > 0) {		for (var i = 0; i < recent.length; i++) {			var venue = recent[i];			$(".recent ul").append("<li>" + venue.date + " - <span class=\"bold\">" + venue.name + "</span> - " + venue.city + ", " + venue.state + "</li>");		}	}	}function getUnapprovedComments() {		$('.newcomments h3').text("New Comments (Updating...)");		var lookupurl = pf_server_url + "?t=mgmt&q=unapprovedcomment";		$.ajax({		url: encodeURI(lookupurl),			dataType: "xml",		success: handleUnapprovedCommentsResult,		error: errorGetLocs	});	}function getUnapprovedLocs() {		$('.unapproved h3').text("New Venues (Updating...)");		var lookupurl = pf_server_url + "?t=mgmt&q=unapproved";		$.ajax({		url: encodeURI(lookupurl),			dataType: "xml",		success: handleUnapprovedLocsResult,		error: errorGetLocs	});	}function handleUnapprovedCommentsResult(xml) {	var status = $(xml).find("status").text();	if (status === "success") {		unapprovedcomments = locXmlToVenues(xml);	} else if (status === "nomatch") {		unapprovedcomments = [];	} else {		alert("status: " + status);	}	refreshUnapprovedCommentsDisplay();}function handleUnapprovedLocsResult(xml) {		var status = $(xml).find("status").text();	if (status === "success") {		unapproved = locXmlToVenues(xml);	} else if (status === "nomatch") {		unapproved = [];	} else {		alert("status: " + status);	}	refreshUnapprovedDisplay();	}function refreshUnapprovedCommentsDisplay() {	$(".newcomments table tbody").empty();	if (unapprovedcomments.length > 0) {		var count = 0;		for (var i = 0; i < unapprovedcomments.length; i++) {			var venue = unapprovedcomments[i];			for (var j = 0; j < venue.comments.length; j++) {				var comment = venue.comments[j];				$(".newcomments table tbody").append("<tr><td><input type=\"hidden\" value=\"" + comment.key + "\" /><label>" + comment.ctext + "</label></td><td><label>" + venue.name + "</label></td><td><input type=\"button\" value=\"Approve\" onclick=\"approveComment(this, " + comment.key + ")\" /><input type=\"button\" value=\"Delete\" onclick=\"deleteComment(this, " + comment.key + ")\" /><input type=\"button\" value=\"Flag Venue\" onclick=\"flagVenue(this, " + venue.key + ")\" /></td></tr>");				count++;			}		}		$('.newcomments h3').text("New Comments (" + count + ")");		$('.newcomments table').show();	} else {		$('.newcomments h3').text("New Comments (None)");		$('.newcomments table').hide();	}}function deleteComment(sender, key) {	$(sender).attr("disabled", "disabled");		$.ajax({		type: "POST",		url: "pf-mgmt.php",		cache: false,		data: {			action: "deletecomment",			key: key			}	}).done(function (data) {				var status = $(data).find('status').text();		if (status === "success") {			getUnapprovedComments();		} else {			alert("Error deleting comment.");		}			});	}// this is the correct one;function approveComment(sender, key) {	$(sender).attr("disabled", "disabled");		$.ajax({		type: "POST",		url: "pf-mgmt.php",		cache: false,		data: {			action: "approvecomment",			key: key			}	}).done(function (data) {				var status = $(data).find('status').text();		if (status === "success") {			getUnapprovedComments();		} else {			alert("Error approving comment.");		}			});	}function approveAddressChangeButtonClick(sender, key) {	$(sender).attr("disabled", "disabled");		$.ajax({		type: "POST",		url: "pf-mgmt.php",		cache: false,		data: {			action: "approveaddresschange",			key: key			}	}).done(function (data) {				var status = $(data).find('status').text();		if (status === "success") {			getAddressChanges();		} else {			alert("Error approving address change.");		}			});}function flagVenue(sender, key) {	$(sender).attr("disabled", "disabled");		// usually flagged from comments;	for (var i = 0; i < unapprovedcomments.length; i++) {		var venue = unapprovedcomments[i];		if (venue.key == key) {			venue.isflagged = true;			saveVenue(venue);			return false;		}	}	}function refreshUnapprovedDisplay() {	$(".unapproved table tbody").empty();	if (unapproved.length > 0) {		for (var i = 0; i < unapproved.length; i++) {			$(".unapproved table tbody").append("<tr><td><input type=\"hidden\" value=\"" + unapproved[i].key + "\" /><input type=\"text\" value=\"" + unapproved[i].name + "\" /></td><td><input type=\"text\" value=\"" + unapproved[i].street + "\" /></td><td><input type=\"text\" value=\"" + unapproved[i].city + "\" /></td><td><input type=\"text\" value=\"" + unapproved[i].state + "\" /></td><td><input type=\"text\" value=\"" + unapproved[i].zipcode + "\" /></td><td><input type=\"text\" value=\"" + unapproved[i].phone + "\" /></td><td><input type=\"text\" value=\"" + unapproved[i].url + "\" /></td><td><input type=\"hidden\" name=\"lat\" value=\"" + unapproved[i].lat + "\" /><input type=\"hidden\" name=\"lon\" value=\"" + unapproved[i].lon + "\" /><a href=\"http://maps.google.com?q=" + unapproved[i].lat + "," + unapproved[i].lon + "\" target=\"map\">" + unapproved[i].lat + "," + unapproved[i].lon + "</a></td><td>" + unapproved[i].games.length + "</td><td><input type=\"button\" value=\"Update\" onclick=\"saveVenueButtonClick(this)\" /><input type=\"button\" value=\"Approve\" onclick=\"approveVenueButtonClick(this)\" /><input type=\"button\" value=\"X\" onclick=\"deleteVenue(this, " + unapproved[i].key + ")\" /></td></tr>");		}		$('.unapproved h3').text("New Venues (" + unapproved.length + ')');		$('.unapproved table').show();	} else {		$('.unapproved h3').text("New Venues (None)");		$('.unapproved table').hide();	}}// yep, this is the correct way again;function deleteVenue(sender, key) {		$(sender).attr("disabled", "disabled");		$.ajax({		type: "POST",		url: "pf-mgmt.php",		cache: false,		data: {			action: "deletevenue",			key: key			}	}).done(function (data) {				var status = $(data).find('status').text();		if (status === "success") {			getUnapprovedLocs();		} else {			alert("Error deleting venue.");		}			});	}function reverseGeocodeVenueButtonClick(sender) {		$(sender).attr("disabled", "disabled");		var index = sender.parentNode.parentNode.rowIndex;		var venue = unapproved[index-1];		var latlng = new google.maps.LatLng(venue.lat, venue.lon);    geocoder.geocode({'latLng': latlng}, function(results, status) {      if (status == google.maps.GeocoderStatus.OK) {        if (results[1]) {          //alert(results[1].formatted_address);		  //alert(results[1]);		  var state = "";		  var city = "";		  var zipcode = "";		  for (var i = 0; i < results[0].address_components.length; i++) {			for (var j = 0; j < results[0].address_components[i].types.length; j++) {				if (results[0].address_components[i].types[j] == "postal_code") {					zipcode = results[0].address_components[i].short_name;				} else if (results[0].address_components[i].types[j] == "locality") {					city = results[0].address_components[i].long_name;				} else if (results[0].address_components[i].types[j] == "administrative_area_level_1") {					state = results[0].address_components[i].long_name;				}			}		  }		  //alert(city + ', ' + state + ' ' + zipcode);		  venue.city = city;		  venue.state = state;		  venue.zipcode = zipcode;		  refreshUnapprovedDisplay();        }      } else {        alert("Geocoder failed due to: " + status);      }    });	}function approveVenueButtonClick(sender) {	$(sender).attr("disabled", "disabled");	var index = sender.parentNode.parentNode.rowIndex;	var venue = unapprovedRowToVenue(index);	venue.isapproved = true;	saveVenue(venue);}function saveVenueButtonClick(sender) {		$(sender).attr("disabled", "disabled");		var index = sender.parentNode.parentNode.rowIndex;		var venue = unapprovedRowToVenue(index);		//if (venue.lat && venue.lon) {	//	saveVenue(venue);	//} else {		geocodeAndSaveVenue(venue);	//}	}function venueToUnapprovedRow(venue) {		for (var i = 0; i < unapproved.length; i++) {		if (unapproved[i].key === venue.key) {			unapproved[i].lat = venue.lat;			unapproved[i].lon = venue.lon;			return false;		}	}	}function unapprovedRowToVenue(index) {		var row = $(".unapproved tr").eq(index);		var key = row.find("td").eq(0).find("input").eq(0).val();	var name = row.find("td").eq(0).find("input").eq(1).val();		var street = row.find("td").eq(1).find("input").eq(0).val();	var city = row.find("td").eq(2).find("input").eq(0).val();	var state = row.find("td").eq(3).find("input").eq(0).val();	var zip = row.find("td").eq(4).find("input").eq(0).val();	var phone = row.find("td").eq(5).find("input").eq(0).val();	var url = row.find("td").eq(6).find("input").eq(0).val();		var lat = row.find("td").eq(7).find("input").eq(0).val();	var lon = row.find("td").eq(7).find("input").eq(1).val();		return new Venue(key, name, street, city, state, zip, phone, lat, lon, url, true, true);	}function saveVenue(venue) {		var locxml = venuesToLocXml(venue);	var payload = locxml;	//alert(payload);		var action = venue.isapproved == true ? "approvevenue" : "updatevenue";		$.ajax({		type: "POST",		url: "pf-mgmt.php",		cache: false,		data: {			locxml: payload,			action: action			}	}).done(function (data) {				var status = $(data).find('status').text();		if (status === "success") {			getUnapprovedLocs();			getUnapprovedComments();			getAddressChanges();		} else {			alert("Error saving venue.");		}			});	}function geocodeAndSaveVenue(venue) {		var address = venue.street + ' ' + venue.city + ' ' + venue.state;		geocoder.geocode( { 'address': address}, function( results, status ) {				if (status == google.maps.GeocoderStatus.OK) {						venue.lat = results[0].geometry.location.lat();			venue.lon = results[0].geometry.location.lng();						// now reverse it;			var latlng = new google.maps.LatLng(venue.lat, venue.lon);			geocoder.geocode({'latLng': latlng}, function(results, status) {			  if (status == google.maps.GeocoderStatus.OK) {								if (results[1]) {				  //alert(results[1].formatted_address);				  //alert(results[1]);				  var state = "";				  var city = "";				  var zipcode = "";				  for (var i = 0; i < results[0].address_components.length; i++) {					for (var j = 0; j < results[0].address_components[i].types.length; j++) {						if (results[0].address_components[i].types[j] == "postal_code") {							zipcode = results[0].address_components[i].short_name;						} else if (results[0].address_components[i].types[j] == "locality") {							city = results[0].address_components[i].long_name;						} else if (results[0].address_components[i].types[j] == "administrative_area_level_1") {							state = results[0].address_components[i].long_name;						}					}				  }				  venue.city = city;				  venue.state = state;				  venue.zipcode = zipcode;				  saveVenue(venue);				}			  } else {				// just save venue;				saveVenue(venue);			  }			});					} else {			// geocode failed, just save venue;			saveVenue(venue);		}			});	}function errorGetLocs() {	alert('There was a server error getting location data.');}